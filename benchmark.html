<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>benchmark</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="benchmark_files/libs/clipboard/clipboard.min.js"></script>
<script src="benchmark_files/libs/quarto-html/quarto.js"></script>
<script src="benchmark_files/libs/quarto-html/popper.min.js"></script>
<script src="benchmark_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="benchmark_files/libs/quarto-html/anchor.min.js"></script>
<link href="benchmark_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="benchmark_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="benchmark_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="benchmark_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="benchmark_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">




<p>Iâ€™ll write a bit about the benchmarks here.</p>
<p>Can run on a normal vector (precludes <code>polars</code>).</p>
<p>Here are the packages under consideration (if you have additions, please open an issue on Github):</p>
<ul>
<li>data.table</li>
<li>zoo</li>
<li>RcppRoll</li>
<li>runner</li>
<li>slider</li>
<li>RollingWindow</li>
<li>roll</li>
<li>runstats</li>
<li>polars</li>
</ul>
<p>We are considering the following computations</p>
<ul>
<li>Mean</li>
<li>Median</li>
<li>Min</li>
<li>Max</li>
<li>Sum</li>
<li>Product</li>
<li>SD</li>
<li>MAD</li>
<li>Correlation</li>
<li>Covariance</li>
<li>Skew</li>
<li>Custom functions</li>
</ul>
<p>We also keep track of various features:</p>
<ul>
<li>Alignment</li>
<li>NA handling</li>
<li>Weight</li>
</ul>
<p>Install <code>data.table</code> form the <code>rollmedian</code> branch:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>renv<span class="sc">::</span><span class="fu">install</span>(<span class="st">'devtools'</span>, <span class="at">prompt =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The following package(s) will be installed:
- devtools [2.4.5]
These packages will be installed into "/Library/Frameworks/R.framework/Versions/4.4-x86_64/Resources/library".

# Installing packages --------------------------------------------------------
- Installing devtools ...                       OK [copied from cache]
Successfully installed 1 package in 0.11 seconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>renv<span class="sc">::</span><span class="fu">install</span>(<span class="st">'microbenchmark'</span>, <span class="at">prompt =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The following package(s) will be installed:
- microbenchmark [1.5.0]
These packages will be installed into "/Library/Frameworks/R.framework/Versions/4.4-x86_64/Resources/library".

# Installing packages --------------------------------------------------------
- Installing microbenchmark ...                 OK [copied from cache]
Successfully installed 1 package in 71 milliseconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>renv<span class="sc">::</span><span class="fu">install</span>(<span class="st">'dplyr'</span>, <span class="at">prompt =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The following package(s) will be installed:
- dplyr [1.1.4]
These packages will be installed into "/Library/Frameworks/R.framework/Versions/4.4-x86_64/Resources/library".

# Installing packages --------------------------------------------------------
- Installing dplyr ...                          OK [copied from cache in 0.11s]
Successfully installed 1 package in 0.13 seconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>renv<span class="sc">::</span><span class="fu">install</span>(<span class="st">'tibble'</span>, <span class="at">prompt =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The following package(s) will be installed:
- tibble [3.2.1]
These packages will be installed into "/Library/Frameworks/R.framework/Versions/4.4-x86_64/Resources/library".

# Installing packages --------------------------------------------------------
- Installing tibble ...                         OK [copied from cache]
Successfully installed 1 package in 0.11 seconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>renv<span class="sc">::</span><span class="fu">install</span>(<span class="st">'zoo'</span>, <span class="at">prompt =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The following package(s) will be installed:
- zoo [1.8-12]
These packages will be installed into "/Library/Frameworks/R.framework/Versions/4.4-x86_64/Resources/library".

# Installing packages --------------------------------------------------------
- Installing zoo ...                            OK [copied from cache]
Successfully installed 1 package in 0.11 seconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>renv<span class="sc">::</span><span class="fu">install</span>(<span class="st">'RcppRoll'</span>, <span class="at">prompt =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The following package(s) will be installed:
- RcppRoll [0.3.1]
These packages will be installed into "/Library/Frameworks/R.framework/Versions/4.4-x86_64/Resources/library".

# Installing packages --------------------------------------------------------
- Installing RcppRoll ...                       OK [copied from cache]
Successfully installed 1 package in 71 milliseconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>renv<span class="sc">::</span><span class="fu">install</span>(<span class="st">'runner'</span>, <span class="at">prompt =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The following package(s) will be installed:
- runner [0.4.4]
These packages will be installed into "/Library/Frameworks/R.framework/Versions/4.4-x86_64/Resources/library".

# Installing packages --------------------------------------------------------
- Installing runner ...                         OK [copied from cache in 0.11s]
Successfully installed 1 package in 0.13 seconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>renv<span class="sc">::</span><span class="fu">install</span>(<span class="st">'slider'</span>, <span class="at">prompt =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The following package(s) will be installed:
- slider [0.3.1]
These packages will be installed into "/Library/Frameworks/R.framework/Versions/4.4-x86_64/Resources/library".

# Installing packages --------------------------------------------------------
- Installing slider ...                         OK [copied from cache]
Successfully installed 1 package in 78 milliseconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>renv<span class="sc">::</span><span class="fu">install</span>(<span class="st">'runstats'</span>, <span class="at">prompt =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The following package(s) will be installed:
- runstats [1.1.0]
These packages will be installed into "/Library/Frameworks/R.framework/Versions/4.4-x86_64/Resources/library".

# Installing packages --------------------------------------------------------
- Installing runstats ...                       OK [copied from cache]
Successfully installed 1 package in 99 milliseconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"Rdatatable/data.table"</span>, <span class="at">ref =</span> <span class="st">"rollmedian"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Using GitHub PAT from the git credential store.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Skipping install of 'data.table' from a github remote, the SHA1 (f4e09b87) has not changed since last install.
  Use `force = TRUE` to force installation</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"jasonjfoster/roll"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Using GitHub PAT from the git credential store.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Skipping install of 'roll' from a github remote, the SHA1 (101e8b53) has not changed since last install.
  Use `force = TRUE` to force installation</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"andrewuhl/RollingWindow"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Using GitHub PAT from the git credential store.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Skipping install of 'RollingWindow' from a github remote, the SHA1 (6c3adda2) has not changed since last install.
  Use `force = TRUE` to force installation</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"pola-rs/r-polars"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Using GitHub PAT from the git credential store.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Skipping install of 'polars' from a github remote, the SHA1 (64c90766) has not changed since last install.
  Use `force = TRUE` to force installation</code></pre>
</div>
</div>
<ul>
<li><code>devtools::install_github("Rdatatable/data.table", ref = "rollmedian")</code></li>
</ul>
<p>Install <code>roll</code> from Github:</p>
<ul>
<li><code>devtools::install_github("jasonjfoster/roll")</code></li>
</ul>
<p>Install <code>RollingWindow</code> from Github:</p>
<ul>
<li><code>devtools::install_github("andrewuhl/RollingWindow")</code></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tibble)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(microbenchmark)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(slider)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(runner)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(zoo)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RollingWindow)</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RcppRoll)</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(roll)</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(runstats)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">rnorm</span>(<span class="dv">1000000</span>))</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">51</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>n_times <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>n_half <span class="ot">&lt;-</span> <span class="fu">floor</span>(n<span class="sc">/</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="mean" class="level2">
<h2 class="anchored" data-anchor-id="mean">Mean</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">microbenchmark</span>(</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"data.table::frollmean"</span> <span class="ot">=</span> data.table<span class="sc">::</span><span class="fu">frollmean</span>(df<span class="sc">$</span>x, n),</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"roll::roll_mean"</span> <span class="ot">=</span> roll<span class="sc">::</span><span class="fu">roll_mean</span>(df<span class="sc">$</span>x, <span class="at">width =</span> n),</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"RollingWindow::RollingMean"</span> <span class="ot">=</span> RollingWindow<span class="sc">::</span><span class="fu">RollingMean</span>(df<span class="sc">$</span>x, n),</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"runstats::RunningMean"</span> <span class="ot">=</span> runstats<span class="sc">::</span><span class="fu">RunningMean</span>(df<span class="sc">$</span>x, <span class="at">W =</span> n),</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"slider::slide_mean"</span> <span class="ot">=</span> slider<span class="sc">::</span><span class="fu">slide_mean</span>(df<span class="sc">$</span>x, <span class="at">before =</span> n_half, <span class="at">after =</span> n_half),</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"RcppRoll::roll_mean"</span> <span class="ot">=</span> RcppRoll<span class="sc">::</span><span class="fu">roll_mean</span>(df<span class="sc">$</span>x, <span class="at">n =</span> n, <span class="at">fill =</span> <span class="cn">NA</span>),</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"zoo::rollmean"</span> <span class="ot">=</span> zoo<span class="sc">::</span><span class="fu">rollmean</span>(df<span class="sc">$</span>x, <span class="at">k =</span> n, <span class="at">fill =</span> <span class="cn">NA</span>),</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"runner::mean_run"</span> <span class="ot">=</span> runner<span class="sc">::</span><span class="fu">mean_run</span>(df<span class="sc">$</span>x, <span class="at">k =</span> n, <span class="at">na_pad =</span> <span class="cn">TRUE</span>),</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> n_times)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: milliseconds
                       expr         min          lq        mean      median
      data.table::frollmean    2.120843    2.653304    3.895271    2.898413
            roll::roll_mean   13.504590   13.925634   18.120092   17.315030
 RollingWindow::RollingMean   17.573932   18.383172   43.981376   23.945119
      runstats::RunningMean   15.437161   23.929622   58.604490   35.127639
         slider::slide_mean   78.291670   80.147562  106.690223   82.284378
        RcppRoll::roll_mean  129.886405  131.962649  153.841379  136.128740
              zoo::rollmean  292.312689  300.750410  569.235484  466.117059
           runner::mean_run 1262.930763 1386.946199 1725.639659 1536.127585
          uq         max neval
    6.038231    7.103118    10
   21.032799   26.411668    10
   34.898958  143.775727    10
   49.857795  228.037001    10
   89.780469  288.245845    10
  140.440563  312.934833    10
  775.945329 1110.021350    10
 2133.097839 2412.535328    10</code></pre>
</div>
</div>
</section>
<section id="median" class="level2">
<h2 class="anchored" data-anchor-id="median">Median</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">microbenchmark</span>(</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"data.table::frollmedian"</span> <span class="ot">=</span> data.table<span class="sc">::</span><span class="fu">frollmedian</span>(df<span class="sc">$</span>x, n),</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"RollingWindow::RollingMedian"</span> <span class="ot">=</span> RollingWindow<span class="sc">::</span><span class="fu">RollingMedian</span>(df<span class="sc">$</span>x, n),</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"zoo::rollmedian"</span> <span class="ot">=</span> zoo<span class="sc">::</span><span class="fu">rollmedian</span>(df<span class="sc">$</span>x, <span class="at">k =</span> n, <span class="at">fill =</span> <span class="cn">NA</span>),</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"roll::roll_median"</span> <span class="ot">=</span> roll<span class="sc">::</span><span class="fu">roll_median</span>(df<span class="sc">$</span>x, <span class="at">width =</span> n),</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"RcppRoll::roll_median"</span> <span class="ot">=</span> RcppRoll<span class="sc">::</span><span class="fu">roll_median</span>(df<span class="sc">$</span>x, <span class="at">n =</span> n, <span class="at">fill =</span> <span class="cn">NA</span>),</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> n_times)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: milliseconds
                         expr        min         lq       mean     median
      data.table::frollmedian   68.69790   71.95110   76.26659   75.95189
 RollingWindow::RollingMedian   55.48946   60.60028   85.58439   69.07675
              zoo::rollmedian  311.92423  323.49728  375.60628  331.34759
            roll::roll_median  491.22467  515.14937  524.80714  527.60018
        RcppRoll::roll_median 1433.77272 1456.07674 1487.65976 1495.47245
         uq        max neval
   80.40898   84.49934    10
   73.72677  262.63985    10
  364.74304  570.03669    10
  536.01784  551.31174    10
 1510.25544 1537.96691    10</code></pre>
</div>
</div>
</section>
<section id="min" class="level2">
<h2 class="anchored" data-anchor-id="min">Min</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">microbenchmark</span>(</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"data.table::frollmin"</span> <span class="ot">=</span> data.table<span class="sc">::</span><span class="fu">frollmin</span>(df<span class="sc">$</span>x, n),</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"roll::roll_min"</span> <span class="ot">=</span> roll<span class="sc">::</span><span class="fu">roll_min</span>(df<span class="sc">$</span>x, <span class="at">width =</span> n),</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"RollingWindow::RollingMin"</span> <span class="ot">=</span> RollingWindow<span class="sc">::</span><span class="fu">RollingMin</span>(df<span class="sc">$</span>x, n),</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"RcppRoll::roll_min"</span> <span class="ot">=</span> RcppRoll<span class="sc">::</span><span class="fu">roll_min</span>(df<span class="sc">$</span>x, <span class="at">n =</span> n, <span class="at">fill =</span> <span class="cn">NA</span>),</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"runner::min_run"</span> <span class="ot">=</span> runner<span class="sc">::</span><span class="fu">min_run</span>(df<span class="sc">$</span>x, <span class="at">k =</span> n, <span class="at">na_pad =</span> <span class="cn">TRUE</span>),</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> n_times)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: milliseconds
                      expr        min         lq       mean      median
      data.table::frollmin   5.108012   5.473566    5.58740    5.578698
            roll::roll_min  22.274261  22.786733   23.91657   23.207872
 RollingWindow::RollingMin  43.948651  44.196130   46.39115   44.745277
        RcppRoll::roll_min 350.369486 357.150156  363.36182  361.322101
           runner::min_run 741.135158 852.562937 1080.57676 1081.215152
          uq         max neval
    5.910413    5.921214    10
   24.317318   28.434708    10
   45.328188   61.662724    10
  369.022586  382.355101    10
 1201.163168 1620.847720    10</code></pre>
</div>
</div>
</section>
<section id="max" class="level2">
<h2 class="anchored" data-anchor-id="max">Max</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">microbenchmark</span>(</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"data.table::frollmax"</span> <span class="ot">=</span> data.table<span class="sc">::</span><span class="fu">frollmax</span>(df<span class="sc">$</span>x, n),</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"roll::roll_max"</span> <span class="ot">=</span> roll<span class="sc">::</span><span class="fu">roll_max</span>(df<span class="sc">$</span>x, <span class="at">width =</span> n),</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"RollingWindow::RollingMax"</span> <span class="ot">=</span> RollingWindow<span class="sc">::</span><span class="fu">RollingMax</span>(df<span class="sc">$</span>x, n),</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"RcppRoll::roll_max"</span> <span class="ot">=</span> RcppRoll<span class="sc">::</span><span class="fu">roll_max</span>(df<span class="sc">$</span>x, <span class="at">n =</span> n, <span class="at">fill =</span> <span class="cn">NA</span>),</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"runner::max_run"</span> <span class="ot">=</span> runner<span class="sc">::</span><span class="fu">max_run</span>(df<span class="sc">$</span>x, <span class="at">k =</span> n, <span class="at">na_pad =</span> <span class="cn">TRUE</span>),</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"zoo::rollmax"</span> <span class="ot">=</span> zoo<span class="sc">::</span><span class="fu">rollmax</span>(df<span class="sc">$</span>x, <span class="at">k =</span> n, <span class="at">fill =</span> <span class="cn">NA</span>),</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> n_times)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: milliseconds
                      expr         min          lq        mean     median
      data.table::frollmax    5.187396    5.282409    6.223864    5.61377
            roll::roll_max   22.782479   22.939588   25.664374   23.64028
 RollingWindow::RollingMax   43.694781   44.977190   74.788910   52.52375
        RcppRoll::roll_max  351.852325  355.645884  370.835741  366.19924
           runner::max_run  711.308279  728.808790  878.349696  805.28062
              zoo::rollmax 1135.601716 1187.682999 1351.960196 1327.56533
          uq         max neval
    6.025845    9.170528    10
   26.260371   40.306106    10
   65.038065  254.448817    10
  378.025764  427.569837    10
  977.274997 1254.226768    10
 1464.879038 1674.056140    10</code></pre>
</div>
</div>
</section>
<section id="sum" class="level2">
<h2 class="anchored" data-anchor-id="sum">Sum</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">microbenchmark</span>(</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"data.table::frollsum, fast"</span> <span class="ot">=</span> data.table<span class="sc">::</span><span class="fu">frollsum</span>(df<span class="sc">$</span>x, n, <span class="at">algo =</span> <span class="st">"fast"</span>),</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"roll::roll_sum"</span> <span class="ot">=</span> roll<span class="sc">::</span><span class="fu">roll_sum</span>(df<span class="sc">$</span>x, <span class="at">width =</span> n),</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RollingWindow::RollingSum"</span> <span class="ot">=</span> RollingWindow<span class="sc">::</span><span class="fu">RollingSum</span>(df<span class="sc">$</span>x, n),</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"slider::slide_sum"</span> <span class="ot">=</span> slider<span class="sc">::</span><span class="fu">slide_sum</span>(df<span class="sc">$</span>x, <span class="at">before =</span> n_half, <span class="at">after =</span> n_half),</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"data.table::frollsum, exact"</span> <span class="ot">=</span> data.table<span class="sc">::</span><span class="fu">frollsum</span>(df<span class="sc">$</span>x, n, <span class="at">algo =</span> <span class="st">"exact"</span>),</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RcppRoll::roll_sum"</span> <span class="ot">=</span> RcppRoll<span class="sc">::</span><span class="fu">roll_sum</span>(df<span class="sc">$</span>x, <span class="at">n =</span> n, <span class="at">fill =</span> <span class="cn">NA</span>),</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"zoo::rollsum"</span> <span class="ot">=</span> zoo<span class="sc">::</span><span class="fu">rollsum</span>(df<span class="sc">$</span>x, n, <span class="at">fill =</span> <span class="cn">NA</span>),</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"runner::sum_run"</span> <span class="ot">=</span> runner<span class="sc">::</span><span class="fu">sum_run</span>(df<span class="sc">$</span>x, <span class="at">k =</span> n, <span class="at">na_pad =</span> <span class="cn">TRUE</span>),</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">times =</span> n_times)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: milliseconds
                        expr         min          lq        mean      median
  data.table::frollsum, fast    2.033221    2.457292    5.806637    2.637065
              roll::roll_sum    6.298811    7.318786   12.432069    7.716829
   RollingWindow::RollingSum   17.335169   18.068821   23.602480   20.803170
           slider::slide_sum   74.482724   74.677650   81.769666   80.177121
 data.table::frollsum, exact   50.175948   50.366473   54.089669   50.981829
          RcppRoll::roll_sum  125.625603  126.983324  135.000375  129.273387
                zoo::rollsum  296.871423  307.329173  437.660855  462.881389
             runner::sum_run 1140.229881 1161.736515 1322.908451 1226.316402
          uq        max neval
    5.818119   19.60800    10
   12.825614   28.81544    10
   28.161511   37.15658    10
   87.509049   95.47419    10
   51.073004   70.92887    10
  143.468527  166.56425    10
  538.465796  577.17347    10
 1494.563401 1815.52448    10</code></pre>
</div>
</div>
</section>
<section id="sd" class="level2">
<h2 class="anchored" data-anchor-id="sd">SD</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">microbenchmark</span>(</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"roll::roll_sd"</span> <span class="ot">=</span> roll<span class="sc">::</span><span class="fu">roll_sd</span>(df<span class="sc">$</span>x, <span class="at">width =</span> n),</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"RollingWindow::RollingStd"</span> <span class="ot">=</span> RollingWindow<span class="sc">::</span><span class="fu">RollingStd</span>(df<span class="sc">$</span>x, n),</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"runstats::RunningSd"</span> <span class="ot">=</span> runstats<span class="sc">::</span><span class="fu">RunningSd</span>(df<span class="sc">$</span>x, <span class="at">W =</span> n),</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"RcppRoll::roll_sd"</span> <span class="ot">=</span> RcppRoll<span class="sc">::</span><span class="fu">roll_sd</span>(df<span class="sc">$</span>x, <span class="at">n =</span> n, <span class="at">fill =</span> <span class="cn">NA</span>),</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> n_times)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: milliseconds
                      expr        min         lq       mean     median
             roll::roll_sd   53.93518   55.82747   60.77677   57.98751
 RollingWindow::RollingStd   29.53720   29.81870   41.17417   32.34727
       runstats::RunningSd   63.45994   73.05778  131.87907  108.89097
         RcppRoll::roll_sd 1123.63029 1197.30150 1212.37037 1227.25477
         uq        max neval
   62.08163   75.40727    10
   49.81090   86.29122    10
  149.20901  271.79077    10
 1245.76278 1255.83131    10</code></pre>
</div>
</div>
</section>
<section id="custom-functions" class="level2">
<h2 class="anchored" data-anchor-id="custom-functions">Custom functions</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">microbenchmark</span>(</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"data.table::frollapply"</span> <span class="ot">=</span> data.table<span class="sc">::</span><span class="fu">frollapply</span>(df<span class="sc">$</span>x, n, sum),</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"zoo::rollapply"</span> <span class="ot">=</span> zoo<span class="sc">::</span><span class="fu">rollapply</span>(df<span class="sc">$</span>x, n, sum),</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> n_times)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: seconds
                   expr       min        lq      mean    median        uq
 data.table::frollapply  3.662903  4.025638  4.106036  4.081609  4.292976
         zoo::rollapply 10.916216 11.330924 12.158687 12.087017 12.640760
       max neval
  4.494102    10
 14.026544    10</code></pre>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>